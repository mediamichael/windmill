import o from"chalk";import{writeFileSync as e}from"node:fs";import{createFilter as t}from"@rollup/pluginutils";import{join as n,relative as r}from"node:path";class u{moduleId;importerModuleIds;children=null;constructor(o,e){this.moduleId=o,this.importerModuleIds=e}}function d(o,e){const t=new Set;!function o(n){t.add(n.moduleId);(function(o){const{importerModuleIds:t}=o;return t.filter((o=>e.get(o))).map((o=>e.get(o)))})(n).forEach((e=>{t.has(e.moduleId)||o(e),n.children||(n.children=new Set),n.children.add(e)}))}(o)}function l(o){const e=new Map,t=new Set;return function o(n,r){const{moduleId:u,children:d}=n;t.has(u)||(r.add(u),d?.forEach((t=>{const{moduleId:n}=t;r.has(n)?function(o,e){const t=o.sort(((o,e)=>o.moduleId<e.moduleId?-1:1)),n=t.map((o=>o.moduleId)).join("-");e.set(n,t)}(function(o,e){const t=[];let n=o;do{if(t.push(n),!n.children)break;n=Array.from(n.children).find((o=>e.has(o.moduleId)))}while(n&&n!==o);return t}(t,r),e):o(t,r)})),t.add(u),r.delete(u))}(o,new Set),e}function c(t,n){const r=function(o,e){return o.formatOut(function(o){return o.reduce(((o,e)=>{const t=e[0];return o[t]||(o[t]=[]),o[t].push(e),o}),{})}(function(o,e){return e.map((e=>e.map((e=>o.formatOutModulePath(e.moduleId)))))}(o,function(o){return Array.from(o.values()).filter((o=>o.length))}(e))))}(t,n);!function(t,n){t.outputFilePath?function(o,t){e(o.outputFilePath,JSON.stringify(t,null,"\t"))}(t,n):function(e,t){Object.entries(t).forEach((t=>{const[n,r]=t;console.group(),console.log("\n\n"+o.yellow(e.formatOutModulePath(n))),r.forEach((e=>{console.log("\t"+e.map((e=>o.red(e))).join(o.blue(" -> ")))})),console.groupEnd()}))}(t,n)}(t,r),function(o,e){if(o.circleImportThrowErr&&e.length)throw new Error("has circular dependencies in this project")}(t,r)}function i(o){const e=function(o){let{include:e=[/\.[jt]sx?$/,/\.vue$/,/\.vue\?vue/,/\.svelte$/],exclude:t=[/[\\/]node_modules[\\/]/,/[\\/]\.git[\\/]/],outputFilePath:r="",circleImportThrowErr:u=!0,formatOutModulePath:d,formatOut:l}=o;r&&(r=n(process.cwd(),r));return{include:e,exclude:t,outputFilePath:r,circleImportThrowErr:u,formatOutModulePath:d??s,formatOut:l??a}}(o),{include:r,exclude:u}=e,d=t(r,u),{getRootModuleNode:l,setRootModuleNode:c,moduleIdNodeMap:i}=function(){const{getRootModuleNode:o,setRootModuleNode:e}=function(){let o;return{getRootModuleNode:()=>o,setRootModuleNode(e){o||(o=e)}}}(),t=new Map;return{getRootModuleNode:o,setRootModuleNode:e,moduleIdNodeMap:t}}();return{...e,filter:d,getRootModuleNode:l,setRootModuleNode:c,moduleIdNodeMap:i}}function s(o){return r(process.cwd(),o)}function a(o){return o}var f=o=>{const e=i(o),{filter:t,getRootModuleNode:n,setRootModuleNode:r,moduleIdNodeMap:s}=e;return{name:"vite-plugin-circular-dependency",moduleParsed:o=>{const{id:e}=o;if(!t(e))return;const n=function(o){const e=function(o){const{importedIds:e,dynamicallyImportedIds:t}=o;return[...e,...t]}(o),{id:t}=o;return new u(t,e)}(o);r(n),s.set(o.id,n)},generateBundle(){const o=n();if(!o)return void console.error("Failed to generate entry module");d(o,s);const t=l(o);c(e,t)}}};export{f as default};
